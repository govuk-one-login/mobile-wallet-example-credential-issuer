# mDL - Issuing Authority Certificate Authority - IACA

## Introduction

The template.yaml in this repo deploys:

- a Private Certificate Authority
- a brand new root certificate for the new root keypair embedded with the Private CA
- a bucket to hold the Certificate Revocation List for the new Certificate Authority
- a CloudFront distribution to sit in front of the bucket, so it is served via a CDN
- a domain name for the CloudFront distribution so the CRL link in the certificates has a stable and controlled DNS name
- a bucket to store access logs generated by CloudFront
- a KMS key to act as the initial document signing key

## Lifecycle

This template should only be deployed once for each stack, and then require minimal changes from that point onwards as the Private CA must remain in place and stable for potentially decades.
The generated root certificate is stored in an SMPS key specified in the EnvironmentVariables Mapping at the top of the file.
A python script is provided to issue a document signing certificate, which itself can then be stored in an SMPS key.

## Generating the Issuer Alternative Name

The `template.yaml` in this folder contains the IssuerAlternativeName which is specified in the EnvironmentVariables Mapping at the top of the file.

All certificates (IACA root certificate, link certificate and document signing certificate) must have an Issuer Alternative Name embedded as an X509v3 extension.

This can be either an email address, URI, or both, and should enable someone viewing the certificate to gain more confidence about the legitimacy of the issuing organisation.
These value(s) need to be specified as an base64 ASN.1 data structure.
This can be generated using the supplied command line utility as:

Email address only:

```bash
private-ca % ./utils/certificate-builder.py -i -e 'hello@example.com'
MBOBEWhlbGxvQGV4YW1wbGUuY29t
```

URI only:

```bash
private-ca % ./utils/certificate-builder.py -i -u 'https://issuer.example.com'
MByGGmh0dHBzOi8vaXNzdWVyLmV4YW1wbGUuY29t
```

Both email address and URI:

```bash
private-ca % ./utils/certificate-builder.py -i -e 'hello@example.com' -u 'https://issuer.example.com'
MC+BEWhlbGxvQGV4YW1wbGUuY29thhpodHRwczovL2lzc3Vlci5leGFtcGxlLmNvbQ==
```

The resulting string needs to be embedded in the Mappings in the template, which is used to create the root certificate

```yaml
Mappings:
  EnvironmentVariables:
    dev:
      IssuerAltName: "MCSGImh0dHBzOi8vbW9iaWxlLmRldi5hY2NvdW50Lmdvdi51ay8="  # base64 ASN.1 encoding of "https://mobile.dev.account.gov.uk/"
```

This must be done once before deploying the stack for the first time.
It cannot be altered after the stack has been deployed.
The generated ASN1 value is stored in the SMPS key specified for future reference when generating document signing keys

## Deploying the stack

> Note: running a Private CA costs USD400/month (pro-rata). If you need to deploy a stack for a short period of time that's fine, but do not leave stacks in branches in DEV running any longer than necessary to avoid unnecessary costs

To deploy the stack in a branch in DEV:



## Generating a Document Signing Key

Generate a Certificate Signing Request for the KMS asymmetric key created in the template

```bash
./utils/certificate-builder.py -c arn:aws:acm-pca:eu-west-2:ACCOUNT-ID:certificate-authority/CA-ID -k arn:aws:kms:eu-west-2:ACCOUNT-ID:key/KMS-KEY-ID -n "Example Issuer Document Signing Certificate" -u "https://mobile.dev.account.gov.uk/"
```
